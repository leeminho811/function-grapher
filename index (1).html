<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>함수 그래프 그리기</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; display: flex; gap: 20px; }
    #controls { flex: 1; }
    #keyboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
    #keyboard button { padding: 10px; font-size: 16px; border-radius: 8px; cursor: pointer; }
    #plot { flex: 3; min-height: 500px; }
    input { width: 100%; padding: 8px; margin: 8px 0; font-size: 16px; }
  </style>
</head>
<body>
  <div id="controls">
    <h2>함수 그래프 그리기</h2>
    <input type="text" id="functionInput" placeholder="예: sin(x), x^2+3x" />
    <button onclick="draw()">그래프 추가</button>
    <button onclick="clearPlot()">모든 그래프 지우기</button>

    <div id="keyboard">
      <button onclick="insertText('sin(')">sin</button>
      <button onclick="insertText('cos(')">cos</button>
      <button onclick="insertText('tan(')">tan</button>
      <button onclick="insertText('log(')">log</button>
      <button onclick="insertText('sqrt(')">√</button>
      <button onclick="insertText('^')">^</button>
      <button onclick="insertText('abs(')">|x|</button>
      <button onclick="insertText('(')">(</button>
      <button onclick="insertText(')')">)</button>
      <button onclick="insertText('x')">x</button>
      <button onclick="insertText('+')">+</button>
      <button onclick="insertText('-')">-</button>
      <button onclick="insertText('*')">×</button>
      <button onclick="insertText('/')">÷</button>
      <button onclick="insertText('0')">0</button>
      <button onclick="insertText('1')">1</button>
      <button onclick="insertText('2')">2</button>
      <button onclick="insertText('3')">3</button>
      <button onclick="insertText('4')">4</button>
      <button onclick="insertText('5')">5</button>
      <button onclick="insertText('6')">6</button>
      <button onclick="insertText('7')">7</button>
      <button onclick="insertText('8')">8</button>
      <button onclick="insertText('9')">9</button>
      <button onclick="clearInput()">지우기</button>
    </div>
  </div>

  <div id="plot"></div>

  <script>
    let allTraces = [];

    function insertText(text) {
      const input = document.getElementById("functionInput");
      const start = input.selectionStart;
      const end = input.selectionEnd;
      input.value = input.value.substring(0, start) + text + input.value.substring(end);
      input.focus();
      input.selectionStart = input.selectionEnd = start + text.length;
    }

    function clearInput() {
      document.getElementById("functionInput").value = "";
    }

    function clearPlot() {
      allTraces = [];
      Plotly.newPlot("plot", []);
    }

    function getRandomColor() {
      const colors = ["red", "blue", "green", "purple", "orange", "brown", "magenta"];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    function getRandomDash() {
      const styles = ["solid", "dot", "dash", "longdash", "dashdot"];
      return styles[Math.floor(Math.random() * styles.length)];
    }

    function draw() {
      const expr = document.getElementById("functionInput").value;
      if (!expr) return alert("함수를 입력하세요!");

      const xValues = Array.from({length: 200}, (_, i) => -10 + i * 0.1);
      let yValues;
      try {
        const scope = { x: 0 };
        const compiled = math.compile(expr);
        yValues = xValues.map(x => {
          scope.x = x;
          return compiled.evaluate(scope);
        });
      } catch (err) {
        return alert("함수 해석 오류: " + err.message);
      }

      const trace = { 
        x: xValues, 
        y: yValues, 
        mode: "lines", 
        type: "scatter",
        name: expr,  // 범례에 함수식 표시
        line: { color: getRandomColor(), dash: getRandomDash(), width: 2 }
      };

      allTraces.push(trace);
      Plotly.newPlot("plot", allTraces, { margin: { t: 20 } });
    }
  </script>
</body>
</html>
